<!doctype html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <base target="_blank" href="../../">
  </head>

  <style>
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #888; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    body {
      margin: 3em 1em;
      color: #bbb;
      font-family: sans-serif;
      background: #1d1d1d;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: start;
      max-width: 1010px;
    }
    @media (min-width: 1024px) {
      body {
        margin: 3em auto;
      }
    }
    pre {
      white-space: pre-wrap;
      width: 100%;
      box-sizing: border-box;
      margin: 1em auto;
    }
    pre.info {
      background: #8881;
      padding: 1em;
    }
    pre.error {
      background: #f772;
      color: #fcc;
      padding: 1em;
    }
    body pre[class*="language-"] {
      background: #242424;
    }
  </style>

  <code_in>
<!--
{{template_input}}
-->
  </code_in>

  <body></body>

  <script>
    const alreadyAppended = {};

    const appendScript = (url) => {
        if(alreadyAppended[url]){ return; }
        return new Promise((resolve, reject) => {
            alreadyAppended[url] = true;
            const script = document.createElement('script');
            script.crossOrigin = "anonymous";
            script.onload = resolve;
            script.src = url;
            document.head.appendChild(script);
        });
    };
    const appendStyleSheet = (url) => {
        if(alreadyAppended[url]){ return; }
        return new Promise((resolve, reject) => {
            alreadyAppended[url] = true;
            const style = document.createElement('link');
            style.rel = "stylesheet";
            style.crossOrigin = "anonymous";
            style.onload = resolve;
            style.href = url;
            document.head.appendChild(style);
        });
    };
    window.appendUrls = async (urls) => {
      const queue = Array.isArray(urls) ? urls : [ urls ];
      
      for(var i=0; i<queue.length; i++){
        const url = queue[i];
        if(url.split('.').pop() === "css"){
          await appendStyleSheet(url);
          continue;
        }
        if(url.split('.').pop() === "js"){
          await appendScript(url);
          continue;
        }
        console.error('error appendUrl: ' + url);
      }
    }

    const prismUrls = [
      "https://unpkg.com/prism-themes@1.4.1/themes/prism-vsc-dark-plus.css",
      "https://unpkg.com/prismjs@1.21.0/components/prism-core.min.js",
      "https://unpkg.com/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js"
    ];

    async function prism(lang, code){
      window.Prism = window.Prism || {};
      Prism.manual = true;
      await appendUrls(prismUrls);
      const preEl = document.createElement('pre');
      const codeEl = document.createElement('code');
      codeEl.innerHTML = code;
      codeEl.className = "language-" + lang;
      preEl.appendChild(codeEl);
      document.body.appendChild(preEl);
      Prism.highlightElement(codeEl);
    }
  </script>
  
  <script>
      const codeIn = document.querySelector('code_in');
      let codeFromComment = Array.from(codeIn.childNodes)
          .filter(x => x.nodeType === 8)
          .map(x => x.data).join('\n');
      if(codeFromComment.trim() === '{{'+'template_input'+'}}'){
        codeFromComment = `
          console.info("hello world");
          prism('javascript', 'console.log("hello world")');
        `.replace(new RegExp('        ', 'g'), '');
      }
      codeFromComment = `${codeFromComment}`;

      console.bak = console.log;
      console.log = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerText = text;
        document.body.appendChild(el);
        console.bak(...args);
      };

      console.bakInfo = console.info;
      console.info = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerText = text;
        el.className = "info";
        document.body.appendChild(el);
        console.bakInfo(...args);
      };

      console.bakError = console.error;
      console.error = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerText = text;
        el.className = "error";
        document.body.appendChild(el);
        console.bakError(...args);
      };

      try {
        const result = eval(codeFromComment);
        if(result && result.then){
          result.catch(console.error)
        }
      } catch(error) {
        console.error({ error });
      }
  </script>
</html>
