<!doctype html>
<html lang="en" id="html">
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="/shared/vendor/stylus.min.js"></script>
    <base target="_blank" href="../../">
  </head>

  <code_in>
<!--
{{template_input}}
-->
  </code_in>

  <body></body>

  <script>
    const delay = ms => new Promise(res => setTimeout(res, ms));
    const alreadyAppended = {};
    const appendScript = (url) => {
        if(alreadyAppended[url]){ return; }
        return new Promise((resolve, reject) => {
            alreadyAppended[url] = true;
            const script = document.createElement('script');
            script.crossOrigin = "anonymous";
            script.onload = resolve;
            script.src = url;
            document.head.appendChild(script);
        });
    };
    /*
    const appendStyleSheet = (url) => {
        if(alreadyAppended[url]){ return; }
        return new Promise((resolve, reject) => {
            alreadyAppended[url] = true;
            const style = document.createElement('link');
            style.rel = "stylesheet";
            style.crossOrigin = "anonymous";
            style.onload = resolve;
            style.href = url;
            document.head.appendChild(style);
        });
    };
    */
    const appendStyleSheet = (url) => {
        if(alreadyAppended[url]) return;
        return new Promise(async (resolve, reject) => {
            alreadyAppended[url] = true;
            const cssBody = await (await fetch(url)).text();
            const style = document.createElement('style');
            style.id = 'foo-'+Math.random().toString().replace('0.','')
            style.textContent = stylus.render(cssBody);
            document.head.appendChild(style);
            resolve();
        });
    };
    window.appendUrls = async (urls=[]) => {
      const queue = Array.isArray(urls)
        ? [ ...urls ]
        : [ urls ];

      for(var i=0; i<queue.length; i++){
        const url = queue[i];
        if(["css", "styl"].includes(url.split('.').pop()) ){
          await appendStyleSheet(url);
          continue;
        }
        if(url.split('.').pop() === "js"){
          await appendScript(url);
          continue;
        }
        console.error('error appendUrl: ' + url);
      }
    }
    
    window.htmlToElement = function htmlToElement(html) {
      var template = document.createElement('template');
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      //also would be cool to remove indentation from all lines
      return template.content.firstChild;
    }

    const prismUrls = [
      "https://unpkg.com/prism-themes@1.4.1/themes/prism-vsc-dark-plus.css",
      "https://unpkg.com/prismjs@1.21.0/components/prism-core.min.js",
      "https://unpkg.com/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js"
    ];

    async function prism(lang, code){
      window.Prism = window.Prism || {};
      Prism.manual = true;
      await appendUrls(prismUrls);
      const preEl = document.createElement('pre');
      const codeEl = document.createElement('code');
      codeEl.innerHTML = code;
      codeEl.className = "language-" + lang;
      preEl.appendChild(codeEl);
      document.body.appendChild(preEl);
      Prism.highlightElement(codeEl);
    }
  </script>
  
  <script>
      const codeIn = document.querySelector('code_in');
      let codeFromComment = Array.from(codeIn.childNodes)
          .filter(x => x.nodeType === 8)
          .map(x => x.data).join('\n');
      if(codeFromComment.trim() === '{{'+'template_input'+'}}'){
        codeFromComment = `
          appendUrls(['../shared.styl']);
          console.info("hello world");
          prism('javascript', 'console.log("hello world")');
        `.replace(new RegExp('        ', 'g'), '');
      }
      codeFromComment = `${codeFromComment}`;

      console.bak = console.log;
      console.log = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerText = text;
        document.body.appendChild(el);
        console.bak(...args);
      };

      console.bakInfo = console.info;
      console.info = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerText = text;
        el.className = "info";
        document.body.appendChild(el);
        console.bakInfo(...args);
      };

      console.bakError = console.error;
      console.error = (...args) => {
        const text = args[0];
        const el = document.createElement('pre');
        el.innerHTML = typeof text === 'object'
          ? JSON.stringify(text, null, 2)
          : text;
        el.className = "error";
        document.body.appendChild(el);
        console.bakError(...args);
      };

      //let AsyncFunction = Object.getPrototypeOf(async function(){}).constructor
      const runCode = (code) => {
        const jsTemplateRun = new Function(`
          try {
            ${code}
          } catch(e){
            console.error({ ...e, stack: e.stack.split('\\n') });
          }
        `);
        jsTemplateRun.name = "jsTemplateRun";
        jsTemplateRun.displayName = "jsTemplateRun";
        return jsTemplateRun();
      }
      
      try {
        const result = runCode(codeFromComment);
        if(result && result.then){
          result.catch(console.error)
        }
      } catch(error) {
        console.error({ ...error, message: error.message, stack: error.stack.split('\n') });
      }
  </script>
</html>
