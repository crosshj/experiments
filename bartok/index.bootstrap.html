<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>service bootstrap</title>
</head>

<style>
    body { background: #1e1e1e; margin: 1px; }
    .w3-border{border:1px solid #ccc!important}
    .w3-grey,.w3-hover-grey:hover,.w3-gray,.w3-hover-gray:hover{color:#000!important;background-color:#9e9e9e!important}
</style>

<body>
    <div class="w3-border">
        <div id="progress-bar" class="w3-grey" style="height:24px;width:0%"></div>
      </div>
</body>

<script>
    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function getServiceWorker() {
        //should ever use navigator.serviceWorker.ready?
        let reg, error;
        if (!('serviceWorker' in navigator)) {
            error = 'no service worker support';
            return console.log('Service worker support is required and not present.  Will not continue.');
        }
        try {
            reg = await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
            reg && console.log('Service worker registration succeeded. Scope is ' + reg.scope);
        } catch (e) {
            error = e;
            error && console.log('Service worker registration failed with ' + error);
        }
        if (!error && !!reg) {
            let count = 0;
            const MAX_COUNT = 10;

            while (!reg.active && count < MAX_COUNT) {
                await delay(300);
                count++;
            }
            if (count >= MAX_COUNT) {
                return console.error('gave up waiting for service worker registration to activate');
            }
        }

        return reg.active;
    }
    const serviceWorkerMessageHandler = (manifest) => {
        const progressBar = document.getElementById('progress-bar');
        const totalModules = manifest.modules.length;
        let doneModules=0;

        return ({ data = {} }) => {
            const { msg, modules, module } = data;

            if(module){
                //module.route && console.log(module.route);
                doneModules++;
                progressBar.style.width = `${100 * doneModules / totalModules}%`;

                // TODO: if this page has a parent, then update progress to it
                // include filesize estimate?

                return;
            }

            console.log(msg);
            //console.log({ manifest });

            //TODO: modules returned should match the manifest

            if (!modules) {
                console.log('bootstrap fail: modules unavailable');
                return;
            }
            localStorage.setItem('moduleCache', JSON.stringify(
                modules
                    .filter(x => x && x.type && x.type === 'domComponent')
                    .map(x => x.route)
            ));
        };
    };

    (async function () {
        const serviceWorker = await getServiceWorker();
        if (!serviceWorker) {
            console.error('bootstrap fail: could not find service worker');
            return;
        }
        const manifestUrl = 'service.manifest.json';
        const manifest = await( await fetch(manifestUrl, { cache: "no-store" })).json();
        if (!manifest) {
            console.error('bootstrap fail: could not find service manifest');
            return;
        }

        navigator.serviceWorker.addEventListener('message', serviceWorkerMessageHandler(manifest));

        serviceWorker.postMessage({
            bootstrap: {
                manifest: manifestUrl
            }
        });
    })();
</script>

</html>